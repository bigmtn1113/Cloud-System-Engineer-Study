# 컨테이너 기술과 Docker 개요

---

## 컨테이너 기술 개요
### 컨테이너
Host OS상에 논리적인 구획을 만들고, 애플리케이션을 동작시키기 위해 필요한 라이브러리나 애플리케이션 등을 하나로 모아, 마치 **별도의 서버**인 것처럼 사용할 수 있게 만든 것

Host OS의 리소스를 논리적으로 분리시키고, 여러 개의 컨테이너가 공유하여 사용

overhead(CPU 자원, 디스크 용량, 메모리 사용량 등)가 적기 때문에 가볍고 고속으로 작동

#### ※ 호스트형 서버 가상화
하드웨어 상에 Host OS를 설치하고, Host OS에 가상화 소프트웨어(VM VirtualBox, VMware Workstation Player 등)를 설치한 후, 이 가상화 소프트웨어 상에서 Guest OS를 작동시키는 기술

간편하게 가상 환경을 구축할 수 있으나, Host OS 상에서 다른 Guest OS를 움직이고 있기 때문에 overhead가 증가한다는 문제점 존재

#### ※ 하이퍼바이저형 서버 가상화
하드웨어 상에 하이버파이저(Hyper-V, XenServer 등)를 배치하고, 하드웨어와 가상환경 제어

Host OS 없이 하드웨어를 직접 제어하기 때문에 효율적으로 사용가능하나, 가상 환경마다 별도의 OS가 작동하므로 가상 환경 시작에 걸리는 overhead가 증가한다는 문제점 존재

---

## Docker 개요
### 프로그래머 입장에서의 Docker
Docker에서는 앱의 실행에 필요한 모든 파일 및 디렉터리들을 컨테이너로서 모아 관리한다.  
이러한 컨테이너 바탕이 되는 Docker 이미지를 Docker Hub와 같은 repository에서 공유한다.

프로그래머는 Docker를 사용하여 개발한 앱의 실행에 필요한 모든 것이 포함되어 있는 Docker 이미지를 작성한다.  
이 이미지는 컨테이너의 바탕이 되고, 이렇게 작성한 이미지를 바탕으로 컨테이너를 가동시킨다.  
이 이미지는 Docker가 설치되어 있는 환경이라면 어디서든지 작동되므로 폭포수 개발의 단점을 해소할 수 있다.

폭포형 개발로 앱을 개발할 때, 개발 환경이나 테스트 환경에서는 올바르게 작동해도 Staging 환경(CD가 일어나는 시스템 개발에서 개발한 앱을 제품 환경에 전개하기 직전에 확인하는 테스트 환경)에서나 제품 환경으로 전개하면 정상적으로 작동하지 않는 경우가 있다.

---

## Docker 기능
### Build
**Docker 이미지 생성**

Docker는 앱 실행에 필요한 프로그램 본체, 라이브러리, 미들웨어, OS나 네트워크 설정 등을 하나로 모아서 Docker 이미지(여러 디렉터리 모음)를 만든다.  
하나의 이미지에는 하나의 앱만 넣어 두고, 여러 개의 컨테이너를 조합하여 서비스를 구축하는 방법을 권장하고 있다.

Docker 이미지는 수동으로 만들 수 있으며, Dockerfile이라는 설정 파일을 만들어 그것을 바탕으로 자동으로 이미지를 만들 수도 있다.  
CI/CD 관점에서 IaC를 생각하면 후자로 하는 것이 바람직한 방법이다.

<br/>

### Ship
**Docker 이미지 공유**

Docker 이미지는 Docker 레지스트리(Docker Hub 등)에서 공유할 수 있다.  
Docker 명령을 사용하면 Docker Hub에 로그인하여 레지스트리에 있는 이미지를 검색이나 upload, download할 수 있다.

#### ※ Docker 이미지의 변조 방지 및 추약성 검사 기능
- **Docker Container Trust**  
  Docker 이미지의 제공자를 검증할 수 있는 기능이다.  
  이미지 제공자는 Docker 레지스트리에 이미지를 송신하기 전에 로컬 환경에서 비밀키를 사용하여 이미지에 서명을 한다.  
  그 후, 그 이미지를 이용할 때는 이미지 제공자의 공개키를 사용하여 실행하려고 하는 이미지가 정말 제공자가 작성한 것인지를 확인한다.  
  만일 이미지가 변조된 경우는 이미지를 무효로 만든다.

- **Docker Security Scanning**  
  Docker 이미지를 검사하여 보안상의 취약성이 없다는 것을 확인함으로써 이미지의 안정성을 확인할 수 있는 기능이다.

<br/>

### Run
**Docker 컨테이너를 작동시키는 기능**

Docker는 Linux 상에서 컨테이너 단위로 서버 기능을 작동시킨다.  
다른 가상화 기술로 실행시키려면 OS의 실행부터 시작하므로 시간이 걸리지만, Docker의 경우는 이미 움직이고 있는 OS 상에서 프로세스를 실행시키는 것과 거의 똑같은 속도로 빨리 실행시킬 수 있다.

Docker는 하나의 Linux 커널을 여러 개의 컨테이너에서 공유한다.  
컨테이너 안에서 작동하는 프로세스를 하나의 그룹으로 관리하고, 그룹마다 각각 파일 시스템이나 호스트명, 네트워크 등을 할당하고 있다.  
그룹이 다르면 프로세스나 파일에 대한 액세스를 할 수 없다.  
이렇게 컨테이너를 독립적으로 관리하기 위해 Linux 커널 기능 기술이 사용된다.

<br/>

### Docker 컴포넌트
- **Docker Engine**  
  **핵심 기능**
	
  Docker 이미지를 생성하고 컨테이너를 기동시키기 위한 기능  
  Docker 명령의 실행이나 Dockerfile에 의한 이미지도 생성

- **Docker Registry**  
  **이미지 공개 및 공유**

  컨테이너의 바탕이 되는 Docker 이미지를 공개 및 공유하기 위한 레지스트리 기능  
  Docker Hub도 이 Docker Registry를 사용

- **Docker Compose**  
  **컨테이너 일원 관리**

  여러 개의 컨테이너 구성 정보를 코드로 정의하고, 명령을 실행함으로써 앱 실행 환경을 구성하는 컨테이너들을 일원 관리하기 위한 툴

- **Docker Machine**  
  **Docker 실행 환경 구축**

  클라우드 환경에 Docker의 실행 환경을 명령으로 자동 생성하기 위한 툴

- **Docker Swarm**  
  **클러스터 관리**

  여러 Docker 호스트를 클러스터화하기 위한 툴  
  클러스터를 관리하거나 API 제공하는 역할은 Manager가, Docker 컨테이너를 실행하는 역할은 Node가 담당한다.  
  또한, Kubernetes를 이용할 수 있다.

---

## Docker 작동 구조
### namespace
**컨테이너를 구획화하는 장치**

Linux 커널의 namespace 기능을 사용  
PID, Network, UID, MOUNT, UTS, IPC의 독립된 환경 구축

<br/>

### cgroups
**릴리스 관리 장치**

Docker는 물리 머신 상의 자원을 여러 컨테이너가 공유하여 작동한다.  
이때 Linux 커널의 기능인 cgroups(control groups) 기능을 사용하여 자원의 할당 등을 관리한다.

cgroups는 프로세스와 스레드를 그룹화하여, 그 그룹 안에 존재하는 프로세스와 스레드에 대한 관리를 수행하는 기능이다.  
예를 들어 Host OS의 CPU나 메모리와 같은 자원에 대해 그룹별로 제한을 둘 수 있다.

cgroups는 계층 구조를 사용하여 프로세스를 그룹화하여 관리할 수 있다.  
cgroups의 부모자식 관계에서는 자식이 부모의 제한을 물려받는다.  
만약 자식이 부모의 제한을 초과하는 설정을 하더라도 부모 cgroups의 제한에 걸린다.

<br/>

### 네트워크 구성
Linux는 Docker를 설치하면 서버의 물리 NIC가 docker0라는 가상 브리지 네트워크로 연결된다.  
이 docker0은 Docker를 실행시킨 후에 default로 만들어진다.

Docker 컨테이너가 실행되면 컨테이너에 172.17.0.0/16이라는 서브넷 마스크를 가진 프라이빗 IP 주소가 eth0으로 자동 할당된다.  
이때 IP를 할당받은 컨테이너의 eth0과 통신을 할 수 있도록 해주는 가상 NIC(veth)가 있다.  
이 가상 NIC는 가상 네트워크 인터페이스로, 페어(컨테이너의 eth0)인 NIC와 터널링 통신(IP 없음)을 한다.  
veth는 docker0과도 연결이 이루어져 네트워크를 구성하게 된다.

etho(물리 NIC) - docker0(가상 브리지) - vethxxxx(가상 NIC) - 컨테이너A의 eth0  
　　　　　　　　　　　　　　　　 　- vethxxxx(가상 NIC) - 컨테이너B의 eth0

Docker 컨테이너와 외부 네트워크가 통신할 땐 docker0와 Host OS의 물리 NIC에서 패킷을 전송하는 장치가 필요하다.  
Docker에서는 NAPT 기능을 사용하여 연결한다.

#### ※ NAT와 NAPT(IP 마스커레이드)
- **NAT(Network Address Translation)**  
  프라이빗 IP 주소가 할당된 클라이언트가 인터넷 상에 있는 서버에 액세스할 때, NAT 라우터는 클라이언트의 프라이빗 IP 주소를 NAT가 갖고 있는 글로벌 IP 주소로 변환하여 요청을 송신한다. 응답은 NAT 라우터가 송신처를 클라이언트의 IP 주소로 변환하여 송신한다.

  글로벌 IP 주소와 프라이빗 IP 주소를 1:1로 변환하므로 동시에 여러 클라이언트가 액세스할 수 없다는 특징이 있다.

- **NAPT(Network Address Port Translation)**  
  프라이빗 IP 주소와 함께 포트 번호도 같이 변환하는 기술이다.  
  프라이빗 IP 주소를 글로벌 IP 주소로 변환할 때 프라이빗 IP 주소별로 서로 다른 포트 번호로 변환한다.

  하나의 글로벌 IP 주소와 여러 개의 프라이빗 IP 주소를 변환할 수 있다는 특징이 있다.  
  IP mascarade(가면무도회). 많은 가면을 쓴 IP 패킷이 포트 번호의 가면을 붙여 변환되는 모습을 나타낸 것이다.
